include/master-slave.inc
[connection master]
CREATE TABLE t1 (a INT PRIMARY KEY) engine=myisam;
#-----------------------
# Case 1: "Empty" XA trx results in no XA statements in binlog
#-----------------------
connection master;
XA START 'x';
INSERT INTO t1 VALUES (1),(1);
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
XA END 'x';
XA PREPARE 'x';
XA COMMIT 'x';
#-----------------------
# Case 2: "Empty" XA trx with disconnect after prepare results in no XA statements in binlog
#-----------------------
connect  con1, 127.0.0.1,root,,test,$MASTER_MYPORT,;
XA START 'x';
INSERT INTO t1 VALUES (2),(2);
ERROR 23000: Duplicate entry '2' for key 'PRIMARY'
XA END 'x';
XA PREPARE 'x';
disconnect con1;
connection master;
XA COMMIT 'x';
ERROR XA100: XA_RBROLLBACK: Transaction branch was rolled back
******** [master] SHOW BINLOG EVENTS  ********
include/show_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000001	#	Gtid	#	#	GTID #-#-#
master-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t1 (a INT PRIMARY KEY) engine=myisam
master-bin.000001	#	Gtid	#	#	BEGIN GTID #-#-#
master-bin.000001	#	Annotate_rows	#	#	INSERT INTO t1 VALUES (1),(1)
master-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
master-bin.000001	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
master-bin.000001	#	Query	#	#	COMMIT
master-bin.000001	#	Gtid	#	#	BEGIN GTID #-#-#
master-bin.000001	#	Annotate_rows	#	#	INSERT INTO t1 VALUES (2),(2)
master-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
master-bin.000001	#	Write_rows_v1	#	#	table_id: # flags: STMT_END_F
master-bin.000001	#	Query	#	#	COMMIT
connection master;
DROP TABLE t1;
include/rpl_end.inc
