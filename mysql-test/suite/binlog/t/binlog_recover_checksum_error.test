# The test verifies server binlog-based recovery.
#
# MDEV-23832 checksum error at server binlog recovery should not crash

# The test logic really requires --log-bin.
--source include/have_binlog_format_mixed.inc
--source include/have_debug.inc

--let $do_checksum = `SELECT @@global.master_verify_checksum`
--let $debug_dbug_saved = `SELECT @@global.debug_dbug`
--let $binlog_checksum = `SELECT @@global.binlog_checksum`
set @@global.binlog_checksum = CRC32;

call mtr.add_suppression("Replication event checksum verification failed");
call mtr.add_suppression("Error in Log_event::read_log_event");
call mtr.add_suppression("Error reading binlog event at file:.*pos:");
call mtr.add_suppression("Crash recovery failed.");
call mtr.add_suppression("Can.t init tc log");
call mtr.add_suppression("Aborting");

# There's no need for actual bin-loggable queries to the server

--source include/kill_mysqld.inc

--echo # Failed restart with corrupted events and  --master_verify_checksum=ON
--error 1
--exec $MYSQLD_LAST_CMD  --master_verify_checksum=ON --debug_dbug="d,corrupt_read_log_event_char" >> $MYSQLTEST_VARDIR/log/mysqld.1.err 2>&1

# Proof of no crash occured ...
let $log_error_ = $MYSQLTEST_VARDIR/log/mysqld.1.err;
--let SEARCH_FILE=$log_error_
--let SEARCH_PATTERN=mysqld got signal 11
--source include/search_pattern_in_file.inc

# ... and that the server stopped with expected errors
--let SEARCH_PATTERN=\[ERROR\] Can\'t init tc log
--source include/search_pattern_in_file.inc
--let SEARCH_PATTERN=\[ERROR\] Aborting
--source include/search_pattern_in_file.inc

#
# Cleanup

--echo # Normal start
--source include/start_mysqld.inc

--replace_regex /= .*/= VALUE/
--eval set @@global.debug_dbug = "$debug_dbug_saved"

--replace_result $do_checksum DO_CHECKSUM
--eval set @@global.master_verify_checksum = $do_checksum
--replace_result $binlog_checksum BINLOG_CHECKSUM
--eval set @@global.binlog_checksum = $binlog_checksum
#
--echo # EOF the test
#
